/*

 Copyright (c) 2012-2013, Andrew Brampton
 All rights reserved.

 Redistribution and use in source and binary forms, with or without
 modification, are permitted provided that the following conditions are met:

 1. Redistributions of source code must retain the above copyright notice,
    this list of conditions and the following disclaimer.
 2. Redistributions in binary form must reproduce the above copyright
    notice, this list of conditions and the following disclaimer in the
    documentation and/or other materials provided with the distribution.

 THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS
 BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 POSSIBILITY OF SUCH DAMAGE.
*/
function Diagram(){this.title=void 0;this.actors=[];this.signals=[]}Diagram.prototype.getActor=function(a){a=a.trim();var b=/^(.+) as (\S+)$/i.exec(a);if(b){var c=b[1].trim();a=b[2].trim()}else c=a.trim();c=c.replace(/\\n/gm,"\n");b=this.actors;for(d in b)if(b[d].alias==a)return b[d];c=new Diagram.Message(c);var d=b.push(new Diagram.Actor(a,c,b.length));return b[d-1]};Diagram.prototype.setTitle=function(a){this.title=a};Diagram.prototype.addSignal=function(a){this.signals.push(a)};
Diagram.Actor=function(a,b,c){this.alias=a;this.name=b;this.index=c};Diagram.Signal=function(a,b,c,d){this.type="Signal";this.actorA=a;this.actorB=c;this.linetype=b&3;this.arrowtype=b>>2&3;this.message=d};Diagram.Signal.prototype.isSelf=function(){return this.actorA.index==this.actorB.index};Diagram.Note=function(a,b,c){this.type="Note";this.actor=a;this.placement=b;this.message=c;if(this.hasManyActors()&&a[0]==a[1])throw Error("Note should be over two different actors");};
Diagram.Message=function(a){this.type="Message";this.text=a.replace(/\\\[/gm,"[").replace(/\\\]/gm,"]").replace(/\\\\/gm,"\\")};Diagram.Message.prototype.setAttr=function(a){this.attr=a};
Diagram.Attributes=function(a){this.type="Attributes";var b=Object.create({},{fill:{value:"black",writable:!0,enumerable:!0,configrable:!0},url:{writable:!0,enumerable:!0,configrable:!0}}),c=Object.create({},{url:{writable:!0,enumerable:!0,configrable:!0},fill:{value:"white",writable:!0,enumerable:!0,configrable:!0}}),d=Object.create({},{url:{writable:!0,enumerable:!0,configrable:!0}}),e=Object.create({},{fill:{writable:!0,enumerable:!0,configrable:!0}});a=a.split(",");a.map(function(g){/^\s*(?:'|")?(.*?)(?:'|")?\s*=\s*(?:'|")(.*?)(?:'|")?\s*$/.exec(g);
g=RegExp.$1.toLowerCase();var h=RegExp.$2;switch(g){case "color":d.stroke=h;break;case "bgcolor":e.fill=h;break;case "fillcolor":c.fill=h;break;case "fontcolor":b.fill=h;break;case "url":case "href":b.href=h,c.href=h,d.href=h}});this.text=b;this.box=c;this.line=d};Diagram.Note.prototype.hasManyActors=function(){return _.isArray(this.actor)};Diagram.LINETYPE={SOLID:0,DOTTED:1};Diagram.ARROWTYPE={FILLED:0,OPEN:1};Diagram.PLACEMENT={LEFTOF:0,RIGHTOF:1,OVER:2};
var grammar=function(){function a(){this.yy={}}var b={trace:function(){},yy:{},symbols_:{error:2,start:3,document:4,EOF:5,line:6,statement:7,NL:8,participant:9,actor:10,signal:11,note_statement:12,title:13,message:14,note:15,placement:16,over:17,actor_pair:18,",":19,left_of:20,right_of:21,signaltype:22,ACTOR:23,attribs:24,linetype:25,arrowtype:26,LINE:27,DOTLINE:28,ARROW:29,OPENARROW:30,MESSAGE:31,MESSAGE_ATTR:32,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",8:"NL",9:"participant",13:"title",15:"note",
17:"over",19:",",20:"left_of",21:"right_of",23:"ACTOR",27:"LINE",28:"DOTLINE",29:"ARROW",30:"OPENARROW",31:"MESSAGE",32:"MESSAGE_ATTR"},productions_:[0,[3,2],[4,0],[4,2],[6,1],[6,1],[7,2],[7,1],[7,1],[7,2],[12,4],[12,4],[18,1],[18,3],[16,1],[16,1],[11,4],[10,1],[10,2],[22,2],[22,1],[25,1],[25,1],[26,1],[26,1],[14,1],[14,2],[24,1]],performAction:function(d,e,g,h,k,l){d=l.length-1;switch(k){case 1:return h;case 6:l[d];break;case 7:h.addSignal(l[d]);break;case 8:h.addSignal(l[d]);break;case 9:h.setTitle(l[d]);
break;case 10:this.$=new Diagram.Note(l[d-1],l[d-2],l[d]);break;case 11:this.$=new Diagram.Note(l[d-1],Diagram.PLACEMENT.OVER,l[d]);break;case 12:this.$=l[d];break;case 13:this.$=[l[d-2],l[d]];break;case 14:this.$=Diagram.PLACEMENT.LEFTOF;break;case 15:this.$=Diagram.PLACEMENT.RIGHTOF;break;case 16:this.$=new Diagram.Signal(l[d-3],l[d-2],l[d-1],l[d]);break;case 17:this.$=h.getActor(l[d]);break;case 18:l[d-1].name.setAttr(l[d]);break;case 19:this.$=l[d-1]|l[d]<<2;break;case 20:this.$=l[d];break;case 21:this.$=
Diagram.LINETYPE.SOLID;break;case 22:this.$=Diagram.LINETYPE.DOTTED;break;case 23:this.$=Diagram.ARROWTYPE.FILLED;break;case 24:this.$=Diagram.ARROWTYPE.OPEN;break;case 25:this.$=new Diagram.Message(l[d].substring(1).trim().replace(/\\n/gm,"\n"));break;case 26:l[d-1].setAttr(l[d]);break;case 27:this.$=new Diagram.Attributes(l[d].substring(1,l[d].length-1))}},table:[{3:1,4:2,5:[2,2],8:[2,2],9:[2,2],13:[2,2],15:[2,2],23:[2,2]},{1:[3]},{5:[1,3],6:4,7:5,8:[1,6],9:[1,7],10:11,11:8,12:9,13:[1,10],15:[1,
12],23:[1,13]},{1:[2,1]},{5:[2,3],8:[2,3],9:[2,3],13:[2,3],15:[2,3],23:[2,3]},{5:[2,4],8:[2,4],9:[2,4],13:[2,4],15:[2,4],23:[2,4]},{5:[2,5],8:[2,5],9:[2,5],13:[2,5],15:[2,5],23:[2,5]},{10:14,23:[1,13]},{5:[2,7],8:[2,7],9:[2,7],13:[2,7],15:[2,7],23:[2,7]},{5:[2,8],8:[2,8],9:[2,8],13:[2,8],15:[2,8],23:[2,8]},{14:15,31:[1,16]},{22:17,24:18,25:19,27:[1,21],28:[1,22],32:[1,20]},{16:23,17:[1,24],20:[1,25],21:[1,26]},{5:[2,17],8:[2,17],9:[2,17],13:[2,17],15:[2,17],19:[2,17],23:[2,17],27:[2,17],28:[2,17],
31:[2,17],32:[2,17]},{5:[2,6],8:[2,6],9:[2,6],13:[2,6],15:[2,6],23:[2,6],24:18,32:[1,20]},{5:[2,9],8:[2,9],9:[2,9],13:[2,9],15:[2,9],23:[2,9],24:27,32:[1,20]},{5:[2,25],8:[2,25],9:[2,25],13:[2,25],15:[2,25],23:[2,25],32:[2,25]},{10:28,23:[1,13]},{5:[2,18],8:[2,18],9:[2,18],13:[2,18],15:[2,18],19:[2,18],23:[2,18],27:[2,18],28:[2,18],31:[2,18],32:[2,18]},{23:[2,20],26:29,29:[1,30],30:[1,31]},{5:[2,27],8:[2,27],9:[2,27],13:[2,27],15:[2,27],19:[2,27],23:[2,27],27:[2,27],28:[2,27],31:[2,27],32:[2,27]},
{23:[2,21],29:[2,21],30:[2,21]},{23:[2,22],29:[2,22],30:[2,22]},{10:32,23:[1,13]},{10:34,18:33,23:[1,13]},{23:[2,14]},{23:[2,15]},{5:[2,26],8:[2,26],9:[2,26],13:[2,26],15:[2,26],23:[2,26],32:[2,26]},{14:35,24:18,31:[1,16],32:[1,20]},{23:[2,19]},{23:[2,23]},{23:[2,24]},{14:36,24:18,31:[1,16],32:[1,20]},{14:37,31:[1,16]},{19:[1,38],24:18,31:[2,12],32:[1,20]},{5:[2,16],8:[2,16],9:[2,16],13:[2,16],15:[2,16],23:[2,16],24:27,32:[1,20]},{5:[2,10],8:[2,10],9:[2,10],13:[2,10],15:[2,10],23:[2,10],24:27,32:[1,
20]},{5:[2,11],8:[2,11],9:[2,11],13:[2,11],15:[2,11],23:[2,11],24:27,32:[1,20]},{10:39,23:[1,13]},{24:18,31:[2,13],32:[1,20]}],defaultActions:{3:[2,1],25:[2,14],26:[2,15],29:[2,19],30:[2,23],31:[2,24]},parseError:function(d,e){if(e.recoverable)this.trace(d);else throw Error(d);},parse:function(d){var e=this,g=[0],h=[null],k=[],l=this.table,f="",m=0,n=0,u=0,z=k.slice.call(arguments,1);this.lexer.setInput(d);this.lexer.yy=this.yy;this.yy.lexer=this.lexer;this.yy.parser=this;"undefined"==typeof this.lexer.yylloc&&
(this.lexer.yylloc={});var x=this.lexer.yylloc;k.push(x);var A=this.lexer.options&&this.lexer.options.ranges;this.parseError="function"===typeof this.yy.parseError?this.yy.parseError:Object.getPrototypeOf(this).parseError;for(var p,y,t,q,v={},w,r;;){t=g[g.length-1];if(this.defaultActions[t])q=this.defaultActions[t];else{if(null===p||"undefined"==typeof p)p=e.lexer.lex()||1,"number"!==typeof p&&(p=e.symbols_[p]||p);q=l[t]&&l[t][p]}if("undefined"===typeof q||!q.length||!q[0]){r=[];for(w in l[t])this.terminals_[w]&&
2<w&&r.push("'"+this.terminals_[w]+"'");var B=this.lexer.showPosition?"Parse error on line "+(m+1)+":\n"+this.lexer.showPosition()+"\nExpecting "+r.join(", ")+", got '"+(this.terminals_[p]||p)+"'":"Parse error on line "+(m+1)+": Unexpected "+(1==p?"end of input":"'"+(this.terminals_[p]||p)+"'");this.parseError(B,{text:this.lexer.match,token:this.terminals_[p]||p,line:this.lexer.yylineno,loc:x,expected:r})}if(q[0]instanceof Array&&1<q.length)throw Error("Parse Error: multiple actions possible at state: "+
t+", token: "+p);switch(q[0]){case 1:g.push(p);h.push(this.lexer.yytext);k.push(this.lexer.yylloc);g.push(q[1]);p=null;y?(p=y,y=null):(n=this.lexer.yyleng,f=this.lexer.yytext,m=this.lexer.yylineno,x=this.lexer.yylloc,0<u&&u--);break;case 2:r=this.productions_[q[1]][1];v.$=h[h.length-r];v._$={first_line:k[k.length-(r||1)].first_line,last_line:k[k.length-1].last_line,first_column:k[k.length-(r||1)].first_column,last_column:k[k.length-1].last_column};A&&(v._$.range=[k[k.length-(r||1)].range[0],k[k.length-
1].range[1]]);t=this.performAction.apply(v,[f,n,m,this.yy,q[1],h,k].concat(z));if("undefined"!==typeof t)return t;r&&(g=g.slice(0,-2*r),h=h.slice(0,-1*r),k=k.slice(0,-1*r));g.push(this.productions_[q[1]][0]);h.push(v.$);k.push(v._$);q=l[g[g.length-2]][g[g.length-1]];g.push(q);break;case 3:return!0}}}},c=function(){var d={EOF:1,parseError:function(e,g){if(this.yy.parser)this.yy.parser.parseError(e,g);else throw Error(e);},setInput:function(e){this._input=e;this._more=this._backtrack=this.done=!1;this.yylineno=
this.yyleng=0;this.yytext=this.matched=this.match="";this.conditionStack=["INITIAL"];this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0};this.options.ranges&&(this.yylloc.range=[0,0]);this.offset=0;return this},input:function(){var e=this._input[0];this.yytext+=e;this.yyleng++;this.offset++;this.match+=e;this.matched+=e;var g=e.match(/(?:\r\n?|\n).*/g);g?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++;this.options.ranges&&this.yylloc.range[1]++;this._input=this._input.slice(1);
return e},unput:function(e){var g=e.length,h=e.split(/(?:\r\n?|\n)/g);this._input=e+this._input;this.yytext=this.yytext.substr(0,this.yytext.length-g-1);this.offset-=g;e=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1);this.matched=this.matched.substr(0,this.matched.length-1);h.length-1&&(this.yylineno-=h.length-1);var k=this.yylloc.range;this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:h?
(h.length===e.length?this.yylloc.first_column:0)+e[e.length-h.length].length-h[0].length:this.yylloc.first_column-g};this.options.ranges&&(this.yylloc.range=[k[0],k[0]+this.yyleng-g]);this.yyleng=this.yytext.length;return this},more:function(){this._more=!0;return this},reject:function(){if(this.options.backtrack_lexer)this._backtrack=!0;else return this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+
this.showPosition(),{text:"",token:null,line:this.yylineno});return this},less:function(e){this.unput(this.match.slice(e))},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(20<e.length?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;20>e.length&&(e+=this._input.substr(0,20-e.length));return(e.substr(0,20)+(20<e.length?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),g=Array(e.length+1).join("-");
return e+this.upcomingInput()+"\n"+g+"^"},test_match:function(e,g){var h;if(this.options.backtrack_lexer){var k={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done};
this.options.ranges&&(k.yylloc.range=this.yylloc.range.slice(0))}if(h=e[0].match(/(?:\r\n?|\n).*/g))this.yylineno+=h.length;this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:h?h[h.length-1].length-h[h.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+e[0].length};this.yytext+=e[0];this.match+=e[0];this.matches=e;this.yyleng=this.yytext.length;this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]);
this._backtrack=this._more=!1;this._input=this._input.slice(e[0].length);this.matched+=e[0];e=this.performAction.call(this,this.yy,this,g,this.conditionStack[this.conditionStack.length-1]);this.done&&this._input&&(this.done=!1);if(e)return e;if(this._backtrack)for(var l in k)this[l]=k[l];return!1},next:function(){if(this.done)return this.EOF;this._input||(this.done=!0);var e;this._more||(this.match=this.yytext="");for(var g=this._currentRules(),h=0;h<g.length;h++)if((e=this._input.match(this.rules[g[h]]))&&
(!k||e[0].length>k[0].length)){var k=e;var l=h;if(this.options.backtrack_lexer){k=this.test_match(e,g[h]);if(!1!==k)return k;if(this._backtrack)k=!1;else return!1}else if(!this.options.flex)break}return k?(k=this.test_match(k,g[l]),!1!==k?k:!1):""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var e=this.next();return e?e:this.lex()},begin:function(e){this.conditionStack.push(e)},
popState:function(){var e=this.conditionStack.length-1;return 0<e?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(e){e=this.conditionStack.length-1-Math.abs(e||0);return 0<=e?this.conditionStack[e]:"INITIAL"},pushState:function(e){this.begin(e)},stateStackSize:function(){return this.conditionStack.length},
options:{"case-insensitive":!0},performAction:function(e,g,h){switch(h){case 0:return 8;case 3:return 9;case 4:return 20;case 5:return 21;case 6:return 17;case 7:return 15;case 8:return 13;case 9:return 19;case 10:return 23;case 11:return 28;case 12:return 27;case 13:return 30;case 14:return 29;case 15:return 31;case 16:return 32;case 17:return 5;case 18:return"INVALID"}},rules:[/^(?:[\n]+)/i,/^(?:\s+)/i,/^(?:#[^\n]*)/i,/^(?:participant\b)/i,/^(?:left of\b)/i,/^(?:right of\b)/i,/^(?:over\b)/i,/^(?:note\b)/i,
/^(?:title\b)/i,/^(?:,)/i,/^(?:[^\[\->:\n,]+)/i,/^(?:--)/i,/^(?:-)/i,/^(?:>>)/i,/^(?:>)/i,/^(?:(\\\\|\\\[|\\\]|[^#\n\[])+)/i,/^(?:\[[^\n\]]+\])/i,/^(?:$)/i,/^(?:.)/i],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18],inclusive:!0}}};return d}();b.lexer=c;a.prototype=b;b.Parser=a;return new a}();function ParseError(a,b){_.extend(this,b);this.name="ParseError";this.message=a||""}ParseError.prototype=Error();
Diagram.parse=function(a){grammar.yy=new Diagram;grammar.yy.parseError=function(b,c){throw new ParseError(b,c);};return grammar.parse(a)};var PLACEMENT=Diagram.PLACEMENT,LINETYPE=Diagram.LINETYPE,ARROWTYPE=Diagram.ARROWTYPE,LINE={stroke:"#000","stroke-width":2},RECT={fill:"#fff"};function AssertException(a){this.message=a}AssertException.prototype.toString=function(){return"AssertException: "+this.message};function assert(a,b){if(!a)throw new AssertException(b);}String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")});function getCenterX(a){return a.x+a.width/2}
Raphael.fn.line=function(a,b,c,d){assert(_.all([a,c,b,d],_.isFinite),"x1,x2,y1,y2 must be numeric");return this.path("M{0},{1} L{2},{3}",a,b,c,d)};Raphael.fn.wobble=function(a,b,c,d){assert(_.all([a,c,b,d],_.isFinite),"x1,x2,y1,y2 must be numeric");var e=Math.sqrt((c-a)*(c-a)+(d-b)*(d-b))/25,g=Math.random(),h=Math.random(),k=.5<Math.random()?e:-e;e=.5<Math.random()?e:-e;g={x:(c-a)*g+a+k,y:(d-b)*g+b+e};a={x:(c-a)*h+a-k,y:(d-b)*h+b-e};return"C"+g.x+","+g.y+" "+a.x+","+a.y+" "+c+","+d};
Raphael.fn.text_bbox=function(a,b){b._obj?a=this.print_center(0,0,a.text,b._obj,b["font-size"]):(a=this.text(0,0,a.text),a.attr(b));b=a.getBBox();a.remove();return b};Raphael.fn.handRect=function(a,b,c,d){assert(_.all([a,b,c,d],_.isFinite),"x, y, w, h must be numeric");return this.path("M"+a+","+b+this.wobble(a,b,a+c,b)+this.wobble(a+c,b,a+c,b+d)+this.wobble(a+c,b+d,a,b+d)+this.wobble(a,b+d,a,b)).attr(RECT)};
Raphael.fn.handLine=function(a,b,c,d){assert(_.all([a,c,b,d],_.isFinite),"x1,x2,y1,y2 must be numeric");return this.path("M"+a+","+b+this.wobble(a,b,c,d))};Raphael.fn.print_center=function(a,b,c,d,e,g){c=this.print(a,b,c,d,e,"baseline",g);d=c.getBBox();a=a-d.x-d.width/2;b=b-d.y-d.height/2;d=new Raphael.matrix;d.translate(a,b);return c.attr("path",Raphael.mapPath(c.attr("path"),d))};var BaseTheme=function(a,b){this.init(a,b)};
_.extend(BaseTheme.prototype,{init:function(a,b){this.diagram=a;this._font=this._paper=void 0;this._options=b;this._default_text_attrs={fill:b.bgcolor,stroke:"none"};this._title=void 0;this._signals_height=this._actors_height=0;a=this.arrow_types={};a[ARROWTYPE.FILLED]="block";a[ARROWTYPE.OPEN]="open";a=this.line_types={};a[LINETYPE.SOLID]="";a[LINETYPE.DOTTED]="-"},init_paper:function(a){this._paper=new Raphael(a,320,200)},init_font:function(){},draw_line:function(a,b,c,d){return this._paper.line(a,
b,c,d)},draw_rect:function(a,b,c,d){return this._paper.rect(a,b,c,d)},draw:function(a){var b=this.diagram;this.init_paper(a);this.init_font();this.layout();a=this._title?this._title.height:0;this._paper.setStart();this._paper.setSize(b.width,b.height);b=10+a;this.draw_title();this.draw_actors(b);this.draw_signals(b+this._actors_height);this._paper.setFinish()},layout:function(){function a(f,m,n){assert(f<m,"a must be less than or equal to b");0>f?(m=e[m],m.x=Math.max(n-m.width/2,m.x)):m>=e.length?
(f=e[f],f.padding_right=Math.max(n,f.padding_right)):(f=e[f],f.distances[m]=Math.max(n,f.distances[m]?f.distances[m]:0))}var b=this.diagram,c=this._paper,d=this._font,e=b.actors,g=b.signals;b.width=0;b.height=0;if(b.title){var h=this._title={},k=c.text_bbox(b.title,d);h.text_bb=k;h.message=b.title;h.width=k.width+10;h.height=k.height+10;h.x=10;h.y=10;b.width+=h.width;b.height+=h.height}_.each(e,function(f){var m=c.text_bbox(f.name,d);f.text_bb=m;f.x=0;f.y=0;f.width=m.width+40;f.height=m.height+40;
f.distances=[];f.padding_right=0;this._actors_height=Math.max(f.height,this._actors_height)},this);_.each(g,function(f){var m=c.text_bbox(f.message,d);f.text_bb=m;f.width=m.width;f.height=m.height;m=0;if("Signal"==f.type)if(f.width+=20,f.height+=20,f.isSelf()){var n=f.actorA.index;var u=n+1;f.width+=20}else n=Math.min(f.actorA.index,f.actorB.index),u=Math.max(f.actorA.index,f.actorB.index);else if("Note"==f.type)if(f.width+=30,f.height+=30,m=20,f.placement==PLACEMENT.LEFTOF)u=f.actor.index,n=u-1;
else if(f.placement==PLACEMENT.RIGHTOF)n=f.actor.index,u=n+1;else if(f.placement==PLACEMENT.OVER&&f.hasManyActors())n=Math.min(f.actor[0].index,f.actor[1].index),u=Math.max(f.actor[0].index,f.actor[1].index),m=-40;else{if(f.placement==PLACEMENT.OVER){n=f.actor.index;a(n-1,n,f.width/2);a(n,n+1,f.width/2);this._signals_height+=f.height;return}}else throw Error("Unhandled signal type:"+f.type);a(n,u,f.width+m);this._signals_height+=f.height},this);var l=0;_.each(e,function(f){f.x=Math.max(l,f.x);_.each(f.distances,
function(m,n){"undefined"!=typeof m&&(n=e[n],m=Math.max(m,f.width/2,n.width/2),n.x=Math.max(n.x,f.x+f.width/2+m-n.width/2))});l=f.x+f.width+f.padding_right},this);b.width=Math.max(l,b.width);b.width+=20;b.height+=20+2*this._actors_height+this._signals_height;return this},draw_title:function(){var a=this._title;a&&this.draw_text_box(a,a.message,0,5,this._font)},draw_actors:function(a){var b=a;_.each(this.diagram.actors,function(c){this.draw_actor(c,b,this._actors_height);this.draw_actor(c,b+this._actors_height+
this._signals_height,this._actors_height);c=getCenterX(c);c=this.draw_line(c,b+this._actors_height-10,c,b+this._actors_height+10+this._signals_height);c.attr(LINE)},this)},draw_actor:function(a,b,c){a.y=b;a.height=c;this.draw_text_box(a,a.name,10,10,this._font)},draw_signals:function(a){var b=a;_.each(this.diagram.signals,function(c){"Signal"==c.type?c.isSelf()?this.draw_self_signal(c,b):this.draw_signal(c,b):"Note"==c.type&&this.draw_note(c,b);b+=c.height},this)},draw_self_signal:function(a,b){assert(a.isSelf(),
"signal must be a self signal");var c=a.text_bb,d=getCenterX(a.actorA);c=d+20+5-c.x;var e=b+a.height/2;this.draw_text(c,e,a.message,this._font);c=_.extend({},LINE,{"stroke-dasharray":this.line_types[a.linetype]});b+=5;e=b+a.height-5;var g=this.draw_line(d,b,d+20,b);g.attr(c);a.message.attr&&g.attr(a.message.attr.line);g=this.draw_line(d+20,b,d+20,e);g.attr(c);a.message.attr&&g.attr(a.message.attr.line);g=this.draw_line(d+20,e,d,e);c["arrow-end"]=this.arrow_types[a.arrowtype]+"-wide-long";g.attr(c);
a.message.attr&&g.attr(a.message.attr.line)},draw_signal:function(a,b){var c=getCenterX(a.actorA),d=getCenterX(a.actorB),e=(d-c)/2+c,g=b+5+10;this.draw_text(e,g,a.message,this._font);g=b+a.height-5-5;b=this.draw_line(c,g,d,g);b.attr(LINE);b.attr({"arrow-end":this.arrow_types[a.arrowtype]+"-wide-long","stroke-dasharray":this.line_types[a.linetype]});a.message.attr&&b.attr(a.message.attr.line)},draw_note:function(a,b){a.y=b;b=a.hasManyActors()?a.actor[0]:a.actor;b=getCenterX(b);switch(a.placement){case PLACEMENT.RIGHTOF:a.x=
b+10;break;case PLACEMENT.LEFTOF:a.x=b-10-a.width;break;case PLACEMENT.OVER:if(a.hasManyActors()){var c=getCenterX(a.actor[1]);a.x=b-20;a.width=c+20-a.x}else a.x=b-a.width/2;break;default:throw Error("Unhandled note placement:"+a.placement);}this.draw_text_box(a,a.message,10,5,this._font)},draw_text:function(a,b,c,d){var e=this._paper;d=d||{};d._obj?a=e.print_center(a,b,c.text,d._obj,d["font-size"]):(a=e.text(a,b,c.text),a.attr(d));b=a.getBBox();e=e.rect(b.x,b.y,b.width,b.height);e.attr(this._default_text_attrs);
c.attr&&(a.attr(c.attr.text),e.attr(c.attr.box));a.toFront()},draw_text_box:function(a,b,c,d,e){d=a.x+c;var g=a.y+c,h=a.width-2*c;c=a.height-2*c;c=this.draw_rect(d,g,h,c);c.attr(LINE);b.attr&&(c.attr(b.attr.box),c.attr(b.attr.line));d=getCenterX(a);g=a.y+a.height/2;this.draw_text(d,g,b,e)}});var RaphaelTheme=function(a,b){this.init(a,b)};_.extend(RaphaelTheme.prototype,BaseTheme.prototype,{init_font:function(){this._font={"font-size":16,"font-family":"Andale Mono, monospace"}}});
var HandRaphaelTheme=function(a,b){this.init(a,b)};_.extend(HandRaphaelTheme.prototype,BaseTheme.prototype,{init_font:function(){this._font={"font-size":16,"font-family":"daniel"};this._font._obj=this._paper.getFont("daniel")},draw_line:function(a,b,c,d){return this._paper.handLine(a,b,c,d)},draw_rect:function(a,b,c,d){return this._paper.handRect(a,b,c,d)}});var themes={simple:RaphaelTheme,hand:HandRaphaelTheme};
Diagram.prototype.drawSVG=function(a,b){var c={theme:"hand",bgcolor:"#fff"};b=_.defaults(b||{},c);if(!(b.theme in themes))throw Error("Unsupported theme: "+b.theme);b=new themes[b.theme](this,b);b.draw(a)};"undefined"!=typeof jQuery&&function(a){a.fn.sequenceDiagram=function(b){return this.each(function(){var c=a(this);try{var d=Diagram.parse(c.text());c.html("");d.drawSVG(this,b)}catch(e){c.html("<pre>"+e.message+"</pre>")}})}}(jQuery);
